name: Send Digest

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

on:
  schedule:
    - cron: "0 8 * * *"  # Daily at 8am
  workflow_dispatch:     # Manual trigger for testing

permissions:
  contents: write

jobs:
  summarize-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get latest summary file content
        id: get_file_content
        run: |
          latest_file=$(ls -rt summaries/ | tail -n1)
          content=$(cat "summaries/$latest_file")
          sanitized_content=$(echo "$content" | jq -R -s .)
          # sanitized_content=$(printf '%s' "$content" | jq -R .)
          echo "file_content=${sanitized_content}" >> $GITHUB_ENV

      - name: Send Email via SendGrid
        run: |
          # Construct the JSON payload
          json_payload=$(jq -n \
          --arg to "barbara@mechanicalgirl.com" \
          --arg from "barbara@mechanicalgirl.com" \
          --arg subject "Latest Summary File" \
          --arg content "${{ env.file_content }}" \
          '{
              personalizations: [{ to: [{ email: $to }] }],
              from: { email: $from },
              subject: $subject,
              content: [{ type: "text/html", value: $content }]
          }')

          # Send the email
          curl --request POST \
            --url https://api.sendgrid.com/v3/mail/send \
            --header "Authorization: Bearer ${{ secrets.SENDGRID_API_KEY }}" \
            --header 'Content-Type: application/json' \
            --data "$json_payload"
